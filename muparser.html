<script type="text/html" data-template-name="muparser">
    <div class="form-row">
        <label for="node-input-expression"><i class="fa fa-calculator"></i> Expression</label>
        <input type="text" id="node-input-expression" placeholder="x + y * sin(z)">
    </div>
    <div class="form-row">
        <label><i class="fa fa-list"></i> Variables</label>
        <table style="width:100%">
            <tr><th>Name</th><th>Value (msg property)</th><th></th></tr>
            <tbody id="node-input-vars"></tbody>
        </table>
        <button class="editor-button" id="node-input-add-var">Add Variable</button>
    </div>
</script>

<script type="text/html" data-help-name="muparser">
    <h3>node-red-contrib-muparser</h3>
    <p><strong>Ultra-fast math expression evaluator using muParser (C++ compiled)</strong></p>
    <p>Performs <strong>18+ million evaluations per second</strong> — ideal for real-time signal processing, control systems, or high-frequency data.</p>

    <h4>How to Use</h4>
    <ol>
        <li><strong>Enter Expression</strong>: Use variables like <code>x</code>, <code>y</code>, <code>temp</code></li>
        <li><strong>Map Variables</strong>: Link to <code>msg.payload.value</code>, <code>msg.x</code>, etc.</li>
        <li><strong>Deploy</strong> → <code>msg.payload</code> = result</li>
    </ol>

    <h4>Example</h4>
    <pre>
Expression: sqrt(x^2 + y^2) + sin(z)
Variables:
  x → payload.x
  y → payload.y
  z → payload.angle
Input:  { "x": 3, "y": 4, "angle": 1.57 }
Output: 5.999... (≈ 6)
    </pre>

    <h4>Supported Operators & Functions</h4>
    <table style="width:100%; font-size:0.9em;">
        <tr><th>Category</th><th>Functions</th></tr>
        <tr><td><strong>Basic</strong></td><td><code>+ - * / ^ ** ( )</code></td></tr>
        <tr><td><strong>Power</strong></td><td><code>pow(a,b) = a^b</code></td></tr>
        <tr><td><strong>Trig</strong></td><td><code>sin cos tan asin acos atan sinh cosh tanh</code></td></tr>
        <tr><td><strong>Log/Exp</strong></td><td><code>ln log10 log2 exp</code></td></tr>
        <tr><td><strong>Rounding</strong></td><td><code>floor ceil round abs sign</code></td></tr>
        <tr><td><strong>Min/Max</strong></td><td><code>min(a,b) max(a,b)</code></td></tr>
        <tr><td><strong>Conditional</strong></td><td><code>if(cond, true, false)</code></td></tr>
        <tr><td><strong>Constants</strong></td><td><code>pi = 3.14159...</code><br><code>e = 2.71828...</code></td></tr>
    </table>

    <h4>Advanced: Multiple Outputs</h4>
    <p>Use commas to return multiple values:</p>
    <pre>
Expression: x * cos(theta), x * sin(theta)
→ msg.payload = [x_coord, y_coord]
    </pre>

    <h4>Performance</h4>
    <ul>
        <li><strong>18M+ evaluations/sec</strong> on modern CPU</li>
        <li><strong>No JavaScript eval()</strong> — safe & fast</li>
        <li>Compiled with <code>node-gyp</code> + <code>muParser</code></li>
    </ul>

    <h4>Tips</h4>
    <ul>
        <li>Use <code>**</code> or <code>^</code> for power</li>
        <li>Parentheses <code>()</code> for grouping</li>
        <li>Case-sensitive variables</li>
        <li>Errors appear in debug tab</li>
    </ul>

    <hr>
    <p><em>Built with muParser — <a href="https://beltoforion.de/en/muparser/" target="_blank">beltoforion.de</a></em></p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('muparser', {
        category: 'function',
        color: '#a6e22e',
        defaults: {
            name: { value: "" },
            expression: { value: "x + y", required: true },
            vars: { value: {} }
        },
        inputs: 1,
        outputs: 1,
        icon: "calculator.svg",
        paletteLabel: "muParser",
        label: function() { return this.name || "muParser"; },
        oneditprepare: function() {
            const table = $("#node-input-vars");
            const vars = this.vars || {};

            function addRow(name, value) {
                const row = $("<tr/>").appendTo(table);
                $("<td/>").append($("<input type='text' style='width:80px'>").val(name)).appendTo(row);
                $("<td/>").append($("<input type='text' style='width:150px'>").val(value)).appendTo(row);
                $("<td/>").append($("<button>X</button>").click(() => row.remove())).appendTo(row);
            }

            Object.keys(vars).forEach(k => addRow(k, vars[k]));
            $("#node-input-add-var").click(() => addRow("", "payload"));
        },
        oneditsave: function() {
            const vars = {};
            $("#node-input-vars tr").each(function() {
                const name = $(this).find("input").eq(0).val().trim();
                const value = $(this).find("input").eq(1).val().trim();
                if (name) vars[name] = value;
            });
            this.vars = vars;
        }
    });
</script>