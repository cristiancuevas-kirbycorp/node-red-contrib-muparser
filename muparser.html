<script type="text/html" data-template-name="muparser">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="muParser">
    </div>
    
    <!-- Expression Section -->
    <div class="form-row" style="margin-top: 20px; padding-bottom: 5px; border-bottom: 1px solid #ddd;">
        <label style="font-weight: bold; width: 100%;"><i class="fa fa-calculator"></i> Expression</label>
    </div>
    <div class="form-row">
        <input type="radio" name="expression-mode" id="node-input-useStaticExpression" value="static" style="width:auto; margin-right: 5px;" checked>
        <label for="node-input-useStaticExpression" style="width: auto; margin-right: 10px;">Static</label>
        <input type="text" id="node-input-expression" placeholder="e.g., sqrt(x^2 + y^2)" style="width:70%;">
    </div>
    <div class="form-row">
        <input type="radio" name="expression-mode" id="node-input-useDynamicExpression" value="dynamic" style="width:auto; margin-right: 5px;">
        <label for="node-input-useDynamicExpression" style="width: auto; margin-right: 10px;">Dynamic</label>
        <input type="hidden" id="node-input-expressionPath">
        <input type="hidden" id="node-input-expressionPathType">
        <div id="node-input-expressionPath-container" style="display: inline-block; width: 70%;"></div>
    </div>
    
    <!-- Variables Section -->
    <div class="form-row" style="margin-top: 20px; padding-bottom: 5px; border-bottom: 1px solid #ddd;">
        <label style="font-weight: bold; width: 100%;"><i class="fa fa-list"></i> Variables</label>
    </div>
    <div class="form-row">
        <input type="radio" name="vars-mode" id="node-input-useStaticVars" value="static" style="width:auto; margin-right: 5px;" checked>
        <label for="node-input-useStaticVars" style="width: auto;">Define manually</label>
    </div>
    <div id="static-vars-section" class="form-row">
        <div id="node-input-vars-container"></div>
    </div>
    <div class="form-row">
        <input type="radio" name="vars-mode" id="node-input-useDynamicVars" value="dynamic" style="width:auto; margin-right: 5px;">
        <label for="node-input-useDynamicVars" style="width: auto; margin-right: 10px;">From object</label>
        <input type="hidden" id="node-input-varsPath">
        <input type="hidden" id="node-input-varsPathType">
        <div id="node-input-varsPath-container" style="display: inline-block; width: 70%;"></div>
    </div>
    <div class="form-row" style="margin-left: 25px;">
        <span style="font-size: 0.85em; color: #999; font-style: italic;">ðŸ’¡ Tip: Use <code>msg.vars</code> to pass variables as an object</span>
    </div>
</script>

<script type="text/html" data-help-name="muparser">
    <h3>node-red-contrib-muparser</h3>
    <p><strong>Ultra-fast math expression evaluator using muParser (C++ compiled)</strong></p>
    <p>Performs <strong>18+ million evaluations per second</strong> â€” ideal for real-time signal processing, control systems, or high-frequency data.</p>

    <h4>How to Use</h4>
    
    <h5>1. Expression</h5>
    <ul>
        <li><strong>Static</strong>: Enter expression directly (e.g., <code>sqrt(x^2 + y^2)</code>)</li>
        <li><strong>From message</strong>: Point to a property containing the expression (e.g., <code>payload.expression</code>)</li>
    </ul>
    
    <h5>2. Variables</h5>
    <ul>
        <li><strong>Define manually</strong>: Map each variable to a message property
            <ul><li>Example: <code>x</code> â†’ <code>payload.x</code>, <code>y</code> â†’ <code>payload.y</code></li></ul>
        </li>
        <li><strong>From object</strong>: Point to an object containing all variables
            <ul><li>Example: Set to <code>payload.vars</code> if <code>msg.payload.vars = {x:3, y:4}</code></li></ul>
        </li>
        <li><strong>Using msg.vars</strong>: Send variables in <code>msg.vars</code> (auto-detected)</li>
    </ul>

    <h4>Example 1: Manual Variables</h4>
    <pre>
Expression: sqrt(x^2 + y^2) + sin(z)
Variables:
  x â†’ payload.x
  y â†’ payload.y
  z â†’ payload.angle
  
Input:  { "payload": { "x": 3, "y": 4, "angle": 1.57 } }
Output: msg.payload = 5.999... (â‰ˆ 6)
    </pre>
    
    <h4>Example 2: Variables from Object</h4>
    <pre>
Expression: temp * 1.8 + 32
Variables from: payload.sensor

Input:  { "payload": { "sensor": { "temp": 25 } } }
Output: msg.payload = 77 (Celsius to Fahrenheit)
    </pre>
    
    <h4>Example 3: Using msg.vars</h4>
    <pre>
Expression: a + b * c
Variables: (none configured - uses msg.vars)

Input:  { "vars": { "a": 10, "b": 5, "c": 2 } }
Output: msg.payload = 20
    </pre>

    <h4>Supported Operators & Functions</h4>
    <table style="width:100%; font-size:0.9em;">
        <tr><th>Category</th><th>Functions</th></tr>
        <tr><td><strong>Basic</strong></td><td><code>+ - * / ^ ** ( )</code></td></tr>
        <tr><td><strong>Power</strong></td><td><code>pow(a,b) = a^b</code></td></tr>
        <tr><td><strong>Trig</strong></td><td><code>sin cos tan asin acos atan sinh cosh tanh</code></td></tr>
        <tr><td><strong>Log/Exp</strong></td><td><code>ln log10 log2 exp</code></td></tr>
        <tr><td><strong>Rounding</strong></td><td><code>floor ceil round abs sign</code></td></tr>
        <tr><td><strong>Min/Max</strong></td><td><code>min(a,b) max(a,b)</code></td></tr>
        <tr><td><strong>Conditional</strong></td><td><code>if(cond, true, false)</code></td></tr>
        <tr><td><strong>Constants</strong></td><td><code>pi = 3.14159...</code><br><code>e = 2.71828...</code></td></tr>
    </table>

    <h4>Advanced: Multiple Outputs</h4>
    <p>Use commas to return multiple values:</p>
    <pre>
Expression: x * cos(theta), x * sin(theta)
â†’ msg.payload = [x_coord, y_coord]
    </pre>

    <h4>Performance</h4>
    <ul>
        <li><strong>18M+ evaluations/sec</strong> on modern CPU</li>
        <li><strong>No JavaScript eval()</strong> â€” safe & fast</li>
        <li>Compiled with <code>node-gyp</code> + <code>muParser</code></li>
    </ul>

    <h4>Tips</h4>
    <ul>
        <li>Use <code>**</code> or <code>^</code> for power</li>
        <li>Parentheses <code>()</code> for grouping</li>
        <li>Case-sensitive variables</li>
        <li>Errors appear in debug tab</li>
    </ul>

    <hr>
    <p><em>Built with muParser â€” <a href="https://beltoforion.de/en/muparser/" target="_blank">beltoforion.de</a></em></p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('muparser', {
        category: 'function',
        color: '#a6e22e',
        defaults: {
            name: { value: "" },
            expression: { value: "x + y", required: true },
            vars: { value: [] },
            useExpressionFrom: { value: false },
            expressionPath: { value: "" },
            expressionPathType: { value: "msg" },
            useVarsFrom: { value: false },
            varsPath: { value: "" },
            varsPathType: { value: "msg" }
        },
        inputs: 1,
        outputs: 1,
        icon: "calculator.svg",
        paletteLabel: "muParser",
        label: function() { return this.name || "muParser"; },
        oneditprepare: function() {
            // Initialize TypedInput for expression path
            $("#node-input-expressionPath-container").typedInput({
                type: this.expressionPathType || "msg",
                types: ["msg", "flow", "global"],
                typeField: "#node-input-expressionPathType"
            });
            $("#node-input-expressionPath-container").typedInput('value', this.expressionPath || 'payload.expression');

            // Initialize TypedInput for vars path
            $("#node-input-varsPath-container").typedInput({
                type: this.varsPathType || "msg",
                types: ["msg", "flow", "global"],
                typeField: "#node-input-varsPathType"
            });
            $("#node-input-varsPath-container").typedInput('value', this.varsPath || 'payload.vars');

            // Initialize editableList for variables
            $("#node-input-vars-container").css({
                'min-height': '280px',
                'height': '280px'
            }).editableList({
                addItem: function(container, i, opt) {
                    const row = opt || {};
                    const html = $('<div/>').css({
                        display: 'flex',
                        alignItems: 'center',
                        gap: '5px',
                        padding: '4px 0',
                        'max-width': '100%'
                    });

                    // Variable name input
                    $('<input/>',{
                        class: "node-input-var-name",
                        type: "text",
                        placeholder: "var"
                    })
                    .css({
                        'width': '90px',
                        'flex-shrink': '0'
                    })
                    .val(row.name || '')
                    .appendTo(html);

                    $('<span/>').text('â†’').css({
                        'margin': '0',
                        'padding': '0 3px',
                        'color': '#999',
                        'flex-shrink': '0'
                    }).appendTo(html);

                    // Create container for TypedInput
                    const valueContainer = $('<div/>').css({
                        'flex': '1 1 auto',
                        'min-width': '0'
                    }).appendTo(html);
                    
                    // Create input element for TypedInput
                    const valueInput = $('<input/>',{
                        class: "node-input-var-value",
                        type: "text"
                    }).css({
                        'width': '100%'
                    }).appendTo(valueContainer);
                    
                    // Hidden input for type
                    $('<input/>',{
                        class: "node-input-var-valueType",
                        type: "hidden"
                    }).val(row.valueType || 'msg').appendTo(valueContainer);

                    // Initialize TypedInput for this row
                    valueInput.typedInput({
                        type: row.valueType || "msg",
                        types: ["msg", "flow", "global", "num", "jsonata"]
                    });
                    valueInput.typedInput('value', row.value || 'payload');

                    html.appendTo(container);
                },
                removable: true,
                sortable: true
            });

            // Convert old format (object) to new format (array) if needed
            let varsList = this.vars;
            if (!Array.isArray(varsList)) {
                // Old format: {x: "payload.x", y: "payload.y"}
                varsList = Object.keys(varsList || {}).map(name => ({
                    name: name,
                    value: varsList[name],
                    valueType: "msg"
                }));
            }

            // Add existing variables to the list
            varsList.forEach(v => {
                $("#node-input-vars-container").editableList('addItem', v);
            });

            // Set initial state for expression mode
            if (this.useExpressionFrom) {
                $("#node-input-useDynamicExpression").prop("checked", true);
                $("#node-input-expression").prop("disabled", true);
                $("#node-input-expressionPath-container").typedInput('enable');
            } else {
                $("#node-input-useStaticExpression").prop("checked", true);
                $("#node-input-expression").prop("disabled", false);
                $("#node-input-expressionPath-container").typedInput('disable');
            }

            // Set initial state for vars mode
            if (this.useVarsFrom) {
                $("#node-input-useDynamicVars").prop("checked", true);
                $("#static-vars-section").hide();
                $("#node-input-varsPath-container").typedInput('enable');
            } else {
                $("#node-input-useStaticVars").prop("checked", true);
                $("#static-vars-section").show();
                $("#node-input-varsPath-container").typedInput('disable');
            }

            // Handle expression mode changes
            $("input[name='expression-mode']").on("change", function () {
                if ($("#node-input-useStaticExpression").is(":checked")) {
                    $("#node-input-expression").prop("disabled", false);
                    $("#node-input-expressionPath-container").typedInput('disable');
                } else {
                    $("#node-input-expression").prop("disabled", true);
                    $("#node-input-expressionPath-container").typedInput('enable');
                }
            });

            // Handle vars mode changes
            $("input[name='vars-mode']").on("change", function () {
                if ($("#node-input-useStaticVars").is(":checked")) {
                    $("#static-vars-section").show();
                    $("#node-input-varsPath-container").typedInput('disable');
                } else {
                    $("#static-vars-section").hide();
                    $("#node-input-varsPath-container").typedInput('enable');
                }
            });
        },
        oneditsave: function() {
            // Save expression settings
            this.useExpressionFrom = $("#node-input-useDynamicExpression").is(":checked");
            this.expressionPath = $("#node-input-expressionPath-container").typedInput('value');
            this.expressionPathType = $("#node-input-expressionPath-container").typedInput('type');

            // Save vars settings
            this.useVarsFrom = $("#node-input-useDynamicVars").is(":checked");
            this.varsPath = $("#node-input-varsPath-container").typedInput('value');
            this.varsPathType = $("#node-input-varsPath-container").typedInput('type');

            // Save variable list
            const vars = [];
            const items = $("#node-input-vars-container").editableList('items');
            items.each(function() {
                const name = $(this).find(".node-input-var-name").val().trim();
                const valueInput = $(this).find(".node-input-var-value");
                if (name && valueInput.length) {
                    const value = valueInput.typedInput('value');
                    const valueType = valueInput.typedInput('type');
                    vars.push({
                        name: name,
                        value: value,
                        valueType: valueType
                    });
                }
            });
            this.vars = vars;
        }
    });
</script>